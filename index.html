<script>
    // DOM Elements
    const loginForm = document.querySelector('.login-form');
    const chatContainer = document.querySelector('.chat-container');
    const messageInput = document.getElementById('messageInput');
    
    // State management
    let socket;
    let retries = 0;
    const maxRetries = 3;

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
        // Load saved username
        const savedUsername = localStorage.getItem('username');
        if (savedUsername) {
            document.getElementById('username').value = savedUsername;
        }

        // Enter key handlers
        document.getElementById('password').addEventListener('keypress', handleEnterKey);
        messageInput.addEventListener('keypress', handleEnterKey);
    });

    function handleEnterKey(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (e.target.id === 'password') {
                login();
            } else {
                sendMessage();
            }
        }
    }

    async function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) throw new Error('Login failed');
            
            const data = await response.json();
            if (data.success) {
                localStorage.setItem('username', username);
                document.getElementById('password').value = ''; // Clear password
                setupChat();
            } else {
                throw new Error('Invalid credentials');
            }
        } catch (error) {
            console.error('Login Error:', error);
            showNotification(error.message || 'Login failed. Please try again.');
        }
    }

    function setupChat() {
        loginForm.style.display = 'none';
        chatContainer.style.display = 'block';
        
        // Initialize Socket.IO connection
        socket = io(window.location.origin, {
            reconnectionAttempts: maxRetries,
            auth: {
                username: localStorage.getItem('username')
            }
        });

        // Socket event handlers
        socket.on('connect', () => {
            retries = 0; // Reset retry counter
            console.log('Connected to server');
        });

        socket.on('previousMessages', messages => {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = ''; // Clear existing messages
            messages.forEach(addMessage);
            scrollToBottom();
        });

        socket.on('newMessage', addMessage);
        
        socket.on('connect_error', (error) => {
            console.error('Connection Error:', error);
            if (retries < maxRetries) {
                const delay = Math.pow(2, retries) * 1000;
                retries++;
                setTimeout(() => socket.connect(), delay);
            } else {
                showNotification('Connection failed. Please refresh the page.');
            }
        });

        socket.on('disconnect', (reason) => {
            if (reason === 'io server disconnect') {
                socket.connect();
            }
        });
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        const username = localStorage.getItem('username');
        
        if (message) {
            socket.emit('sendMessage', { username, message }, (ack) => {
                if (ack?.error) {
                    showNotification('Message failed to send');
                }
            });
            messageInput.value = '';
        }
    }

    function addMessage(msg) {
        const messagesDiv = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `
            <strong>${msg.username}:</strong> 
            <span>${msg.message}</span>
            <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
        `;
        messagesDiv.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showNotification(text, duration = 3000) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = text;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, duration);
    }
</script>
